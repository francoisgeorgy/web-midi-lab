<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Web MIDI Lab - Events</title>
    <meta name="description" content="Test Web MIDI in your browser">
    <meta name="author" content="francois.georgy@gmail.com">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <style>
        .wrapper {
            display: flex;
            margin-bottom: 20px;
        }
        .wrapped-left {
            flex:0;
        }
        .wrapped-middle {
            flex:1;
            margin-left: 50px;
        }
        .wrapped-right {
            flex:2;
            margin-left: 50px;
        }
        span.changed {
            background-color: #00ccff;
        }
        span.dim {
            color: #aaa;
        }
    </style>
</head>
<body>

    <h2>web midi lab - sysex</h2>
    <hr />
    <button id="clear" />clear</button>
    <div id="data" style="font-family: Courier New, Courier, monospace; white-space: pre"></div>

    <script>
        const SYSEX_MSG = 0b11110000;

        var midi = null;  // global MIDIAccess object

        var prev_data = null;

        const COLS = 16;
        const EOL = '\n';

        /*
        function propagateRight1(v) {
            return v == 0 ? 0 : (v | (v-1));
        }
        */

        String.prototype.padZero = function (len, c) {
            var s = '', c = c || '0', len = (len || 2) - this.length;
            while (s.length < len) s += c;
            return s + this;
        }

        function dim(s) {
            return s;   // on affiche seulement 7 bits, plus besoin de dimmer
            //return '<span class="dim">' + s + '</span>';
        }

        function dim1(s) {
            return dim(s.substr(0, 1)) + s.substr(1)
            //return '<span class="dim">' + s.substr(0, 1) + '</span>' + s.substr(1);
        }

        function b(v) {
            return v.toString(2).padZero(7);    // 7 bits !!!
        }

        function h(v) {
            return v.toString(16).padZero(2);    
        }

        function hex(a, prefix='', separator=' ') {
            //if (a.length < 1) return '';
            var s = a.reduce((acc, val) => {return acc + separator + prefix + h(val)}, "");
            return s.trim();
        }

        function getBinRepr(data, ref_data = null) {
            var s = '    ';
            row = 0;
            for (var i = 0; i < 8; i++) {
                s += `<span class="dim">      ${i} </span>`;
            }
            s += EOL;

            var k = 0;
            for (var i=0; i < data.byteLength; i++) {

                if ((k % 8) == 0) {
                    s += '<span class="dim">' + k.toString(10).padZero(3) + '</span> ';
                }

                var changed = (ref_data != null) && (data[i] != ref_data[i]);
                if (changed) {
                    d0 = b(ref_data[i]);
                    d1 = b(data[i]);
                    o = '';
                    for (var n = 0; n < d1.length; n++) {
                        if (d1.charAt(n) != d0.charAt(n)) {
                            o += '<span class="changed">' + d1.charAt(n) + '</span>';
                        } else {
                            if (n == 0) {
                                o += dim(d1.charAt(n));
                            } else {
                                o += d1.charAt(n);
                            }
                        }
                    }
                    s += o + ' ';
                } else {
                    s += dim1(b(data[i])) + ' ';
                }
                k++;
                if ((k % 8) == 0) {
                    s += EOL;
                }
            }
            return s;
        }

        function getHexRepr(data, ref_data = null) {

            var s = '    ';
            row = 0;
            for (var i = 0; i < 8; i++) {
                s += ` <span class="dim">${i}</span> `;
            }
            s += EOL;

            var k = 0;
            for (var i = 0; i < data.byteLength; i++) {

                if ((k % 8) == 0) {
                    s += '<span class="dim">' + k.toString(10).padZero(3) + '</span> ';
                }

                var changed = (ref_data != null) && (data[i] != ref_data[i]);

                if (changed) {
                    d0 = h(ref_data[i]);
                    d1 = h(data[i]);
                    o = '';
                    for (var n = 0; n < d1.length; n++) {
                        if (d1.charAt(n) != d0.charAt(n)) {
                            o += '<span class="changed">' + d1.charAt(n) + '</span>';
                        } else {
                            if (n == 0) {
                                o += dim(d1.charAt(n));
                            } else {
                                o += d1.charAt(n);
                            }
                        }
                    }
                    s += o + ' ';
                } else {
                    s += dim1(h(data[i])) + ' ';
                }

                k++;
                if ((k % 8) == 0) {
                    s += EOL;
                }
               
            }
            return s;
        }

        function getFirstDiff(a, b) {
            var start = -1;
            var length = 0; // length == 0 means no diff found.
            var mask = [];
            if ((typeof b === 'undefined') || (b == null)) {
                return { start, length, mask: mask };
            }
            for (var i=0; i<Math.min(a.byteLength, b.byteLength); i++) {
                if (a[i] == b[i]) {
                    if (start < 0) {
                        continue; 
                    } else { 
                        return { start, length, mask: mask };
                    }
                }
                if (start < 0) {
                    start = i;
                }
                mask.push(a[i] ^ b[i]);
                length++;
            }
            return { start, length, mask: mask };
        }

        function handleMessage(event) {
            //console.log("handleMessage", event);
            if (event instanceof MIDIMessageEvent) {
                //var bytes = event.data;
                //console.log("data", event.data)
                if (event.data[0] == SYSEX_MSG) {
                
                    var bytes = event.data.slice(1, -1);
                
                    //console.log("sysex", bytes)
                 

                    var bin_repr = getBinRepr(bytes, prev_data);
                    var hex_repr = getHexRepr(bytes, prev_data);                
                    var diff = getFirstDiff(bytes, prev_data);
                    //console.log(diff);

                    var masks_bin = diff.mask.reduce((acc, val) => {return acc + '\n' + val.toString(2).padZero(8)}, "");
                    //console.log(masks_bin); 

                    var mask = hex(diff.mask, '0x');
                    var diff_repr = `\nstart:  ${diff.start}\nlength: ${diff.length}\nmask:   [${mask}]\n\n${diff.start}, ${diff.length}, [${hex(diff.mask, '0x')}]\n${masks_bin}`;
                    
                    $("#data").prepend(`<div class="wrapper"><div class="wrapped-left">${bin_repr}</div><div class="wrapped-middle">${hex_repr}</div><div class="wrapped-right">${diff_repr}</div></div>`);
                    prev_data = bytes;
                }
            }
        }

        function subscribeInputs(midiAccess) {
            var inputs = midiAccess.inputs.values();
            // loop over all available inputs
            for (var input = inputs.next(); input && !input.done; input = inputs.next()) {
                input.value.onmidimessage = handleMessage;
            }
        }

        $(function () {

            navigator.requestMIDIAccess({ sysex: true }).then(onMIDISuccess, onMIDIFailure);

            function onMIDISuccess(midiAccess) {
                console.log("Got access to MIDI");
                midi = midiAccess;
                subscribeInputs(midi);
            }

            function onMIDIFailure(msg) {
                console.log("onMIDIFailure", msg);
                //printr("Failed to get MIDI access - " + msg, "#states");
            }

            $('#clear').click(function () { $('#data').empty(); });

        });
    </script>
</body>
</html>